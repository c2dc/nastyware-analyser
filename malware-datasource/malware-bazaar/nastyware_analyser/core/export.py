import requests
import pandas as pd
import os
import sys
import pefile

from nastyware_analyser.core.request import request_information

def export_dataset(sample_dir, output_filename):
    samples = os.listdir(sample_dir)

    samples_len = len(samples)

    if samples_len == 0:
        print('No samples to export dataset.')
        sys.exit(1)

    with open(output_filename, 'w') as f:
        for index, sample in enumerate(samples):
            print(f'\r[{index + 1}/{samples_len}] Getting information of hash: {sample}', end='')
            filehash = sample.split('.')[0]     # File format: <hash>.<extension>
            sample_information_df = request_information(hash=filehash)
            f.write(sample_information_df.to_csv(header=True if index == 0 else False, index=False))

        print()

def export_imports(files_dir, output_dir, malware=False):
    files = os.listdir(files_dir)
    
    files_len = len(files)

    if files_len == 0:
        print('No files to export function imports.')
        sys.exit(1)

    prefix = "RANS" if malware else "GOOD"
    for file in files:
        pe = pefile.PE(f'{files_dir}/{file}')

        try:
            with open(f'{output_dir}/{prefix}-{file}', 'w') as f:
                for entry in pe.DIRECTORY_ENTRY_IMPORT:
                    for function in entry.imports:
                        if function.name != None:
                            f.write(f'{entry.dll} {function.name}')

        except AttributeError:
            print(f'{file} does not have imports.')
