import json
import pandas as pd

MALWARE_SOURCES_FILE = 'malware_sources.json'

class Dataset:
    def __init__(self, source_data, source):
        if source_data is None:
            raise Exception('source_data is None')

        self.source_data = source_data
        self.source = source

        with open(MALWARE_SOURCES_FILE) as f:
            malware_sources = json.load(f)

        data = {}

        for malware_source in malware_sources:
            if malware_sources[malware_source]['template'] is None:
                continue
            
            self._add_keys_to_dict(data, malware_sources[malware_source]['template'])

        self._assign_values_to_dict(data, source_data, malware_sources[source]['template'])

        self.data = pd.json_normalize(data)
    
    def to_csv(self, header=False, index=False):
        return self.data.to_csv(header=header, index=index)

    def _add_keys_to_dict(self, data, template):
        for key in template:
            if isinstance(template[key], dict):
                data[key] = {}
                self._add_keys_to_dict(data[key], template[key])
            else:
                data[template[key]] = None

    def _assign_values_to_dict(self, data, source_data, template):
        for key in template:
            if key not in source_data:
                continue

            if isinstance(template[key], dict):
                self._assign_values_to_dict(data[key], source_data[key], template[key])
            else:
                data[template[key]] = source_data[key]
